const MessageTest = artifacts.require('MessageTest.sol')

const { expect } = require('chai')
const { addTxHashToAMBData } = require('../helpers/helpers')

contract('ArbitraryMessage.sol', async () => {
  describe('unpackData', () => {
    it('unpack dataType 0x00', async () => {
      // given
      const msgSender = '0x003667154bb32E42bb9e1E6532F19d187fa0082e'
      const msgContractAddress = '0xf4BEF13F9f4f2B203FAF0C3cBbaAbe1afE056955'
      const msgTxHash = '0xbdceda9d8c94838aca10c687da1411a07b1390e88239c0638cb9cc264219cc10'
      const msgGasLimit = '1535604485'
      const msgGasPrice = '0'
      const msgDataType = '0x00'
      const msgData = '0xb1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03'
      // event message generated by
      // requireToPassMessage(address _contract, bytes _data, uint256 _gas)
      const eventMessage =
        '0x003667154bb32e42bb9e1e6532f19d187fa0082e' + // sender
        'f4bef13f9f4f2b203faf0c3cbbaabe1afe056955' + // contractAddress
        '000000000000000000000000000000000000000000000000000000005b877705' + // gasLimit
        '00' + // dataType
        'b1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03' // data

      // validator needs to add txHash into message
      const message = addTxHashToAMBData(eventMessage, msgTxHash)

      // when
      const messageTest = await MessageTest.new()
      const result = await messageTest.unpackData(message)

      // then
      const { sender, executor, txHash, gasLimit, dataType, gasPrice, data } = result
      expect(sender).to.be.equal(msgSender)
      expect(executor).to.be.equal(msgContractAddress)
      expect(txHash).to.be.equal(msgTxHash)
      expect(gasLimit.toString()).to.be.equal(msgGasLimit)
      expect(dataType).to.be.equal(msgDataType)
      expect(gasPrice.toString()).to.be.equal(msgGasPrice)
      expect(data).to.be.equal(msgData)
    })

    it('unpack dataType 0x01', async () => {
      // given
      const msgSender = '0xc95e32f5b21AEA8107aA2c645636E909489031e8'
      const msgContractAddress = '0xf4BEF13F9f4f2B203FAF0C3cBbaAbe1afE056955'
      const msgTxHash = '0x27aa676e59e4feaafcfde2b88c6002b756795c1260762512ba26ff28fdaf0f64'
      const msgGasLimit = '1535604485'
      const msgGasPrice = '6000000000'
      const msgDataType = '0x01'
      const msgData = '0xb1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03'
      // event message generated by
      // requireToPassMessage(address _contract, bytes _data, uint256 _gas, uint256 _gasPrice)
      const eventMessage =
        '0xc95e32f5b21aea8107aa2c645636e909489031e8' + // sender
        'f4bef13f9f4f2b203faf0c3cbbaabe1afe056955' + // contractAddress
        '000000000000000000000000000000000000000000000000000000005b877705' + // gasLimit
        '01' + // dataType
        '0000000000000000000000000000000000000000000000000000000165a0bc00' + // gasPrice
        'b1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03' // data

      // validator needs to add txHash into message
      const message = addTxHashToAMBData(eventMessage, msgTxHash)

      // when
      const messageTest = await MessageTest.new()
      const result = await messageTest.unpackData(message)

      // then
      const { sender, executor, txHash, gasLimit, dataType, gasPrice, data } = result
      expect(sender).to.be.equal(msgSender)
      expect(executor).to.be.equal(msgContractAddress)
      expect(txHash).to.be.equal(msgTxHash)
      expect(gasLimit.toString()).to.be.equal(msgGasLimit)
      expect(dataType).to.be.equal(msgDataType)
      expect(gasPrice.toString()).to.be.equal(msgGasPrice)
      expect(data).to.be.equal(msgData)
    })

    it('unpack dataType 0x02', async () => {
      // given
      const msgSender = '0xe0241f385c58c88911531DDFe3B5f0fc729BdaEe'
      const msgContractAddress = '0xf4BEF13F9f4f2B203FAF0C3cBbaAbe1afE056955'
      const msgTxHash = '0xbdceda9d8c94838aca10c687da1411a07b1390e88239c0638cb9cc264219cc10'
      const msgGasLimit = '1535604485'
      const msgGasPrice = '0'
      const msgDataType = '0x02'
      const msgData = '0xb1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03'
      // event message generated by
      // requireToPassMessage(address _contract, bytes _data, uint256 _gas, bytes1 _oracleGasPriceSpeed)
      const eventMessage =
        '0xe0241f385c58c88911531ddfe3b5f0fc729bdaee' + // sender
        'f4bef13f9f4f2b203faf0c3cbbaabe1afe056955' + // contractAddress
        '000000000000000000000000000000000000000000000000000000005b877705' + // gasLimit
        '02' + // dataType
        '10b1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03' // data

      // validator needs to add txHash into message
      const message = addTxHashToAMBData(eventMessage, msgTxHash)

      // when
      const messageTest = await MessageTest.new()
      const result = await messageTest.unpackData(message)

      // then
      const { sender, executor, txHash, gasLimit, dataType, gasPrice, data } = result
      expect(sender).to.be.equal(msgSender)
      expect(executor).to.be.equal(msgContractAddress)
      expect(txHash).to.be.equal(msgTxHash)
      expect(gasLimit.toString()).to.be.equal(msgGasLimit)
      expect(dataType).to.be.equal(msgDataType)
      expect(gasPrice.toString()).to.be.equal(msgGasPrice)
      expect(data).to.be.equal(msgData)
    })
  })
  describe('unpackData with signatures parameters', () => {
    it('unpack dataType 0x00', async () => {
      // given
      const msgSender = '0x003667154bb32E42bb9e1E6532F19d187fa0082e'
      const msgContractAddress = '0xf4BEF13F9f4f2B203FAF0C3cBbaAbe1afE056955'
      const msgTxHash = '0xbdceda9d8c94838aca10c687da1411a07b1390e88239c0638cb9cc264219cc10'
      const msgGasLimit = '1535604485'
      const msgGasPrice = '0'
      const msgDataType = '0x00'
      const msgData = '0xb1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03'
      // event message generated by
      // requireToPassMessage(address _contract, bytes _data, uint256 _gas)
      const eventMessage =
        '0x003667154bb32e42bb9e1e6532f19d187fa0082e' + // sender
        'f4bef13f9f4f2b203faf0c3cbbaabe1afe056955' + // contractAddress
        '000000000000000000000000000000000000000000000000000000005b877705' + // gasLimit
        '00' + // dataType
        'b1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03' // data

      // validator needs to add txHash into message
      const message = addTxHashToAMBData(eventMessage, msgTxHash)

      // when
      const messageTest = await MessageTest.new()
      const result = await messageTest.unpackDataWithExtraParams(message, '0x')

      // then
      const { sender, executor, txHash, gasLimit, dataType, gasPrice, data } = result
      expect(sender).to.be.equal(msgSender)
      expect(executor).to.be.equal(msgContractAddress)
      expect(txHash).to.be.equal(msgTxHash)
      expect(gasLimit.toString()).to.be.equal(msgGasLimit)
      expect(dataType).to.be.equal(msgDataType)
      expect(gasPrice.toString()).to.be.equal(msgGasPrice)
      expect(data).to.be.equal(msgData)
    })

    it('unpack dataType 0x01', async () => {
      // given
      const msgSender = '0xc95e32f5b21AEA8107aA2c645636E909489031e8'
      const msgContractAddress = '0xf4BEF13F9f4f2B203FAF0C3cBbaAbe1afE056955'
      const msgTxHash = '0x27aa676e59e4feaafcfde2b88c6002b756795c1260762512ba26ff28fdaf0f64'
      const msgGasLimit = '1535604485'
      const msgGasPrice = '6000000000'
      const msgDataType = '0x01'
      const msgData = '0xb1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03'
      // event message generated by
      // requireToPassMessage(address _contract, bytes _data, uint256 _gas, uint256 _gasPrice)
      const eventMessage =
        '0xc95e32f5b21aea8107aa2c645636e909489031e8' + // sender
        'f4bef13f9f4f2b203faf0c3cbbaabe1afe056955' + // contractAddress
        '000000000000000000000000000000000000000000000000000000005b877705' + // gasLimit
        '01' + // dataType
        '0000000000000000000000000000000000000000000000000000000165a0bc00' + // gasPrice
        'b1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03' // data

      // validator needs to add txHash into message
      const message = addTxHashToAMBData(eventMessage, msgTxHash)

      // when
      const messageTest = await MessageTest.new()
      const result = await messageTest.unpackDataWithExtraParams(message, '0x')

      // then
      const { sender, executor, txHash, gasLimit, dataType, gasPrice, data } = result
      expect(sender).to.be.equal(msgSender)
      expect(executor).to.be.equal(msgContractAddress)
      expect(txHash).to.be.equal(msgTxHash)
      expect(gasLimit.toString()).to.be.equal(msgGasLimit)
      expect(dataType).to.be.equal(msgDataType)
      expect(gasPrice.toString()).to.be.equal(msgGasPrice)
      expect(data).to.be.equal(msgData)
    })

    it('unpack dataType 0x02', async () => {
      // given
      const msgSender = '0xe0241f385c58c88911531DDFe3B5f0fc729BdaEe'
      const msgContractAddress = '0xf4BEF13F9f4f2B203FAF0C3cBbaAbe1afE056955'
      const msgTxHash = '0xbdceda9d8c94838aca10c687da1411a07b1390e88239c0638cb9cc264219cc10'
      const msgGasLimit = '1535604485'
      const msgGasPrice = '0'
      const msgDataType = '0x02'
      const msgData = '0xb1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03'
      // event message generated by
      // requireToPassMessage(address _contract, bytes _data, uint256 _gas, bytes1 _oracleGasPriceSpeed)
      const eventMessage =
        '0xe0241f385c58c88911531ddfe3b5f0fc729bdaee' + // sender
        'f4bef13f9f4f2b203faf0c3cbbaabe1afe056955' + // contractAddress
        '000000000000000000000000000000000000000000000000000000005b877705' + // gasLimit
        '02' + // dataType
        '10b1591967aed668a4b27645ff40c444892d91bf5951b382995d4d4f6ee3a2ce03' // data

      // validator needs to add txHash into message
      const message = addTxHashToAMBData(eventMessage, msgTxHash)

      // when
      const messageTest = await MessageTest.new()
      const result = await messageTest.unpackDataWithExtraParams(message, '0x')

      // then
      const { sender, executor, txHash, gasLimit, dataType, gasPrice, data } = result
      expect(sender).to.be.equal(msgSender)
      expect(executor).to.be.equal(msgContractAddress)
      expect(txHash).to.be.equal(msgTxHash)
      expect(gasLimit.toString()).to.be.equal(msgGasLimit)
      expect(dataType).to.be.equal(msgDataType)
      expect(gasPrice.toString()).to.be.equal(msgGasPrice)
      expect(data).to.be.equal(msgData)
    })
  })
})
